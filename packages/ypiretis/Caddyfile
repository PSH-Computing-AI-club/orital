{
	servers {
		trusted_proxies static private_ranges
	}
}

http://:{$SERVER_PORT} {
	@static_files {
		path /assets/* /fonts/* /images/* /models/* /uploads/* /apple-touch-icon.png /favicon.ico /favicon.svg /favicon-96x96.png /site.webmanifest /web-app-manifest-192x192.png /web-app-manifest-512x512.png
	}

	@severe_impact_routes {
		method DELETE PATCH POST PUT

		path /authentication/log-in/
	}

	@moderate_impact_routes {
		method DELETE PATCH POST PUT

		path /authentication/* /rooms/*
	}

	@low_impact_routes {
		path / /authentication/* /calendar/* /news/* /r/* /rooms/*
	}

	handle @static_files {
		reverse_proxy {$PROXIED_SERVER_HOST}:{$PROXIED_SERVER_PORT}
	}

	handle @severe_impact_routes {
		rate_limit {
			zone severe_impact {
				key {remote_host}

				events 5
				window 60s
			}
		}
	}

	handle @moderate_impact_routes {
		rate_limit {
			zone moderate_impact {
				key {remote_host}

				events 24
				window 60s
			}
		}
	}

	handle @low_impact_routes {
		rate_limit {
			zone low_impact {
				key {remote_host}

				events 64
				window 60s
			}
		}
	}

	rate_limit {
		zone global_impact {
			key {remote_host}

			events 512
			window 60s
		}
	}

	reverse_proxy {$PROXIED_SERVER_HOST}:{$PROXIED_SERVER_PORT}
}
